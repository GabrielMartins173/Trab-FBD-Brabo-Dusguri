ALTER TABLE COMPROMISSO DROP FOREIGN KEY FK_REUNIAO;
DROP VIEW IF EXISTS COMPROMISSO_REUNIAO;
DROP TABLE IF EXISTS REUNIAO;
DROP TABLE IF EXISTS LISTA_DE_CONTATOS;
DROP TABLE IF EXISTS CALENDARIO;
DROP TABLE IF EXISTS USUARIO;
DROP TABLE IF EXISTS USUARIO_PREMIUM;
DROP TABLE IF EXISTS METODO_DE_PAGAMENTO;
DROP TABLE IF EXISTS COMPROMISSO;
DROP TABLE IF EXISTS SALA_DE_REUNIAO;

CREATE TABLE METODO_DE_PAGAMENTO (
	NOME CHAR(20) PRIMARY KEY,
	DESCRICAO VARCHAR(255)
);

CREATE TABLE SALA_DE_REUNIAO (
	NOME VARCHAR(100) PRIMARY KEY
);

CREATE TABLE COMPROMISSO (
	COMPROMISSO_ID NUMERIC PRIMARY KEY,
	DATA_DE_INICIO TIMESTAMP NOT NULL,
	DATA_DE_TERMINO TIMESTAMP NOT NULL,
	DESCRICAO VARCHAR(255) NOT NULL
	
);

CREATE TABLE USUARIO_PREMIUM (
	USUARIO_PREMIUM_ID NUMERIC PRIMARY KEY,
	DATA_DE_TERMINO TIMESTAMP NOT NULL,
	ULTIMO_PAGAMENTO TIMESTAMP NOT NULL,
	METODO_DE_PAGAMENTO CHAR(20) NOT NULL,
	
	FOREIGN KEY (METODO_DE_PAGAMENTO) REFERENCES METODO_DE_PAGAMENTO(NOME)
);

CREATE TABLE USUARIO (
	USUARIO_ID NUMERIC PRIMARY KEY,
	NOME VARCHAR(200) NOT NULL,
	SENHA VARCHAR(20) NOT NULL,
	EMAIL VARCHAR(200) NOT NULL,
	TELEFONE NUMERIC,
	USUARIO_PREMIUM_ID NUMERIC,
	
	FOREIGN KEY (USUARIO_PREMIUM_ID) REFERENCES USUARIO_PREMIUM(USUARIO_PREMIUM_ID)
);

CREATE TABLE LISTA_DE_CONTATOS (
	LISTA_DE_CONTATOS_ID NUMERIC,
	NOME VARCHAR(100) NOT NULL,
	DONO NUMERIC NOT NULL,
	USUARIO_ID NUMERIC,
	
	PRIMARY KEY (LISTA_DE_CONTATOS_ID, USUARIO_ID),
	FOREIGN KEY (DONO) REFERENCES USUARIO(USUARIO_ID),
	FOREIGN KEY (USUARIO_ID) REFERENCES USUARIO(USUARIO_ID)
);

CREATE TABLE CALENDARIO (
	USUARIO_ID NUMERIC,
	COMPROMISSO_ID NUMERIC,
	
	PRIMARY KEY (USUARIO_ID, COMPROMISSO_ID),
	FOREIGN KEY (USUARIO_ID) REFERENCES USUARIO(USUARIO_ID),
	FOREIGN KEY (COMPROMISSO_ID) REFERENCES COMPROMISSO(COMPROMISSO_ID)
);

CREATE TABLE REUNIAO (
	REUNIAO_ID NUMERIC,
	NOME VARCHAR(100) NOT NULL,
	SALA_DE_REUNIAO VARCHAR(100) NOT NULL,
	USUARIO_ID NUMERIC NOT NULL,
	
	PRIMARY KEY(REUNIAO_ID, USUARIO_ID),
	FOREIGN KEY (USUARIO_ID) REFERENCES USUARIO(USUARIO_ID),
	FOREIGN KEY (SALA_DE_REUNIAO) REFERENCES SALA_DE_REUNIAO(NOME)
);

ALTER TABLE COMPROMISSO
ADD COLUMN REUNIAO_ID NUMERIC AFTER DESCRICAO,
ADD CONSTRAINT FK_REUNIAO FOREIGN KEY (REUNIAO_ID) REFERENCES REUNIAO(REUNIAO_ID);

CREATE TRIGGER ATUALIZA_CALENDARIO AFTER INSERT
ON COMPROMISSO
FOR EACH ROW
	INSERT INTO CALENDARIO (USUARIO_ID, COMPROMISSO_ID)
	SELECT DISTINCT R.USUARIO_ID, C.COMPROMISSO_ID FROM REUNIAO R JOIN COMPROMISSO C USING(REUNIAO_ID) WHERE COMPROMISSO_ID = NEW.COMPROMISSO_ID;

CREATE VIEW COMPROMISSO_REUNIAO AS SELECT * FROM COMPROMISSO JOIN REUNIAO USING(REUNIAO_ID);

#inserir metodo de pagamento
INSERT INTO METODO_DE_PAGAMENTO (NOME, DESCRICAO)
VALUES('Boleto', 'Pago em boleto o valor de x meses de premium');
INSERT INTO METODO_DE_PAGAMENTO (NOME, DESCRICAO)
VALUES('Assinatura', 'Debito em conta automatico mensal do usuario');

#insert sala de reuniao
INSERT INTO SALA_DE_REUNIAO (NOME) 
VALUES('Sala 103');
INSERT INTO SALA_DE_REUNIAO (NOME) 
VALUES('Sala 104');
INSERT INTO SALA_DE_REUNIAO (NOME) 
VALUES('Sala 112');
INSERT INTO SALA_DE_REUNIAO (NOME) 
VALUES('Sala 115');

#inserir usuario_premium
INSERT INTO USUARIO_PREMIUM (USUARIO_PREMIUM_ID, DATA_DE_TERMINO, ULTIMO_PAGAMENTO, METODO_DE_PAGAMENTO)
values(1, DATE_ADD(CURDATE(), INTERVAL 7 MONTH), DATE_SUB(CURDATE(), INTERVAL 1 MONTH), 'Boleto');
INSERT INTO USUARIO_PREMIUM (USUARIO_PREMIUM_ID, DATA_DE_TERMINO, ULTIMO_PAGAMENTO, METODO_DE_PAGAMENTO)
values(2, DATE_ADD(CURDATE(), INTERVAL 1 MONTH), DATE_SUB(CURDATE(), INTERVAL 1 MONTH), 'Assinatura');

#inserir usuarios
insert into usuario (usuario_id, nome, senha, email, telefone, usuario_premium_id)
values(1, 'Alan', 'password', 'alan.soledar@hotmail.com', 123456789, 1);
insert into usuario (usuario_id, nome, senha, email, telefone, usuario_premium_id)
values(2, 'Gabriel', 'senha', 'gabriel.martins@hotmail.com', 223456788, 2);
insert into usuario (usuario_id, nome, senha, email, telefone)
values(3, 'Leonardo', 'admin', 'leo.augusto@gmail.com', 323456788);
insert into usuario (usuario_id, nome, senha, email, telefone)
values(4, 'Richard', '1234', 'richard.leal@gmal.com', 423456789);
insert into usuario (usuario_id, nome, senha, email, telefone)
values(5, 'Giovani', 'data de aniversario', 'Giovani.simon@hotmail.com', 523456789);

#inserir lista de contatos
insert into lista_de_contatos (lista_de_contatos_id, nome, DONO, USUARIO_ID)
values(2, 'DellBrabo', 2, 1);
insert into lista_de_contatos (lista_de_contatos_id, nome, DONO, USUARIO_ID)
values(2, 'DellBrabo', 2, 4);
insert into lista_de_contatos (lista_de_contatos_id, nome, DONO, USUARIO_ID)
values(2, 'DellBrabo', 2, 5);
insert into lista_de_contatos (lista_de_contatos_id, nome, DONO, USUARIO_ID)
values(1, 'Usguri', 1, 2);
insert into lista_de_contatos (lista_de_contatos_id, nome, DONO, USUARIO_ID)
values(1, 'Usguri', 1, 3);
insert into lista_de_contatos (lista_de_contatos_id, nome, DONO, USUARIO_ID)
values(1, 'Usguri', 1, 4);
insert into lista_de_contatos (lista_de_contatos_id, nome, DONO, USUARIO_ID)
values(1, 'Usguri', 1, 5);

#insert reuniao
INSERT INTO REUNIAO(REUNIAO_ID, NOME, SALA_DE_REUNIAO, USUARIO_ID)
VALUES(1, 'FBD 1', 'Sala 103', 1);
INSERT INTO REUNIAO(REUNIAO_ID, NOME, SALA_DE_REUNIAO, USUARIO_ID)
VALUES(1, 'FBD 1', 'Sala 103', 2);
INSERT INTO REUNIAO(REUNIAO_ID, NOME, SALA_DE_REUNIAO, USUARIO_ID)
VALUES(2, 'FBD 2', 'Sala 115', 1);
INSERT INTO REUNIAO(REUNIAO_ID, NOME, SALA_DE_REUNIAO, USUARIO_ID)
VALUES(2, 'FBD 2', 'Sala 115', 2);
INSERT INTO REUNIAO(REUNIAO_ID, NOME, SALA_DE_REUNIAO, USUARIO_ID)
VALUES(2, 'FBD 2', 'Sala 115', 4);

#insert compromisso
INSERT INTO COMPROMISSO (COMPROMISSO_ID, DATA_DE_INICIO, DATA_DE_TERMINO, DESCRICAO, REUNIAO_ID)
values(1, DATE_ADD(CURDATE(), INTERVAL 1 WEEK), DATE_ADD(CURDATE(), INTERVAL 2 WEEK), 'Licenca medica', NULL);
INSERT INTO COMPROMISSO (COMPROMISSO_ID, DATA_DE_INICIO, DATA_DE_TERMINO, DESCRICAO, REUNIAO_ID)
values(2, DATE_ADD(DATE_ADD(CURDATE(), INTERVAL 1 WEEK),INTERVAL 14 HOUR), DATE_ADD(DATE_ADD(CURDATE(), INTERVAL 1 WEEK),INTERVAL 16 HOUR), 'Para tratar de negocios', 1);


#achar todos os contatos de todas as listas de contatos de um usuario
SELECT LDC.NOME, U.* FROM USUARIO DONO 
JOIN LISTA_DE_CONTATOS LDC ON DONO.USUARIO_ID = DONO
JOIN USUARIO U ON U.USUARIO_ID = LDC.USUARIO_ID
WHERE DONO.NOME = 'Alan';